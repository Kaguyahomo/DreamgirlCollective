<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin â€” Word Bank</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        .word-input-section {
            margin-bottom: 2rem;
        }
        .definition-preview {
            background-color: rgba(255,255,255,0.3);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            text-align: left;
            display: none;
        }
        .definition-preview.show {
            display: block;
        }
        .word-bank {
            background-color: rgba(255,255,255,0.2);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .word-bank ul {
            list-style: none;
            padding: 0;
            margin: 0;
            text-align: left;
        }
        .word-bank li {
            padding: 0.5rem;
            margin: 0.5rem 0;
            background-color: rgba(255,255,255,0.3);
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .word-bank li button {
            margin-left: 10px;
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        .word-info {
            flex: 1;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .error-msg {
            color: #cc0000;
            font-weight: bold;
        }
        .success-msg {
            color: #00aa00;
            font-weight: bold;
        }
        h3 {
            color: #ff3377;
            border-bottom: 2px solid #ff88bb;
            padding-bottom: 0.5rem;
        }
        .logout-btn {
            position: fixed;
            top: 15px;
            right: 15px;
            background: #ff88bb;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>

<body>

<button class="logout-btn" onclick="logout()">Logout</button>

<header>
    <img src="../header-image.png" class="header-image left">
    <h1>Vocabulary Admin</h1>
    <img src="../header-image.png" class="header-image right">
</header>

<nav>
    <a href="../kaguya.html"><img src="../header-image.png"></a>
    <a href="index.html"><img src="../header-image.png"></a>
</nav>

<section>

    <h2>Word Bank Manager</h2>

    <!-- Add New Word Section -->
    <div class="word-input-section">
        <h3>Add New Word</h3>
        <input id="new-word" placeholder="Enter a word..." onkeyup="handleWordInput(event)">
        <button onclick="fetchDefinition()">Lookup Definition</button>
        
        <div id="definition-preview" class="definition-preview">
            <p><strong>Word:</strong> <span id="preview-word"></span></p>
            <p><strong>Definition:</strong> <span id="preview-definition"></span></p>
            <button onclick="addWordToBank()">Add to Word Bank</button>
        </div>
        
        <p id="lookup-status"></p>
    </div>

    <hr style="margin:2rem 0; border-color: #ff88bb;">

    <!-- Unused Words Bank -->
    <div>
        <h3>ðŸ“š Word Bank (Unused Words)</h3>
        <p style="font-size: 0.9rem; color: #666;">Words waiting to be used in quizzes</p>
        <div id="unused-words" class="word-bank">
            <p class="loading">Loading words...</p>
        </div>
    </div>

    <hr style="margin:2rem 0; border-color: #ff88bb;">

    <!-- Tested Words Section -->
    <div>
        <h3>âœ… Words Already Tested</h3>
        <p style="font-size: 0.9rem; color: #666;">Words that have been sent out as quiz questions</p>
        <div id="tested-words" class="word-bank">
            <p class="loading">Loading tested words...</p>
        </div>
    </div>

</section>

<footer>
    <p>Dreamgirl Collective - Admin Panel</p>
</footer>

<script>
const API = "https://renelaird.pages.dev/api";

// Check authentication on page load
function checkAuth() {
    const auth = sessionStorage.getItem("vocabAdminAuth");
    if (auth !== "true") {
        window.location.href = "index.html";
    }
}

function logout() {
    sessionStorage.removeItem("vocabAdminAuth");
    window.location.href = "index.html";
}

// Fetch definition from Wiktionary API (primary) with Free Dictionary API fallback
async function fetchDefinition() {
    const word = document.getElementById("new-word").value.trim();
    if (!word) {
        showStatus("Please enter a word", "error");
        return;
    }
    
    showStatus("Looking up definition...", "loading");
    
    // Try Wiktionary API first (more comprehensive coverage)
    let definition = await fetchFromWiktionary(word);
    
    // Fall back to Free Dictionary API if Wiktionary doesn't have it
    if (!definition) {
        definition = await fetchFromFreeDictionary(word);
    }
    
    if (definition) {
        document.getElementById("preview-word").textContent = word;
        document.getElementById("preview-definition").textContent = definition;
        document.getElementById("definition-preview").classList.add("show");
        showStatus("Definition found!", "success");
    } else {
        showStatus("Word not found in dictionaries. You can enter a custom definition below.", "error");
        document.getElementById("preview-word").textContent = word;
        document.getElementById("preview-definition").innerHTML = '<input id="custom-definition" placeholder="Enter custom definition..." style="width: 80%;">';
        document.getElementById("definition-preview").classList.add("show");
    }
}

// Fetch from Wiktionary API - broader coverage including uncommon words
async function fetchFromWiktionary(word) {
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        const res = await fetch(`https://en.wiktionary.org/api/rest_v1/page/definition/${encodeURIComponent(word)}`, {
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!res.ok) {
            return null;
        }
        
        const data = await res.json();
        
        // Wiktionary returns definitions organized by language then part of speech
        if (data && data.en && data.en.length > 0) {
            for (const entry of data.en) {
                if (entry.definitions && entry.definitions.length > 0) {
                    const partOfSpeech = entry.partOfSpeech || "";
                    // Get the definition text, strip HTML tags
                    let defText = entry.definitions[0].definition || "";
                    defText = defText.replace(/<[^>]*>/g, '').trim();
                    
                    if (defText) {
                        return partOfSpeech ? `(${partOfSpeech}) ${defText}` : defText;
                    }
                }
            }
        }
        
        return null;
    } catch (err) {
        console.error("Wiktionary API error:", err);
        return null;
    }
}

// Fetch from Free Dictionary API - fallback for common words
async function fetchFromFreeDictionary(word) {
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`, {
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!res.ok) {
            return null;
        }
        
        const data = await res.json();
        
        if (data && data.length > 0 && data[0].meanings && data[0].meanings.length > 0) {
            const meanings = data[0].meanings;
            
            for (const meaning of meanings) {
                if (meaning.definitions && meaning.definitions.length > 0) {
                    const partOfSpeech = meaning.partOfSpeech || "";
                    const def = meaning.definitions[0].definition || "";
                    
                    if (def) {
                        return partOfSpeech ? `(${partOfSpeech}) ${def}` : def;
                    }
                }
            }
        }
        
        return null;
    } catch (err) {
        console.error("Free Dictionary API error:", err);
        return null;
    }
}

function showStatus(message, type) {
    const statusEl = document.getElementById("lookup-status");
    statusEl.textContent = message;
    statusEl.className = type === "error" ? "error-msg" : type === "success" ? "success-msg" : "loading";
}

function handleWordInput(event) {
    if (event.key === "Enter") {
        fetchDefinition();
    }
}

// Add word to the bank
async function addWordToBank() {
    const word = document.getElementById("preview-word").textContent.trim();
    let definition = document.getElementById("preview-definition").textContent.trim();
    
    // Check if there's a custom definition input
    const customDefInput = document.getElementById("custom-definition");
    if (customDefInput) {
        definition = customDefInput.value.trim();
    }
    
    if (!word || !definition) {
        showStatus("Word and definition are required", "error");
        return;
    }
    
    try {
        await fetch(`${API}/words/add`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({word, definition, tested: false})
        });
        
        showStatus("Word added to bank!", "success");
        document.getElementById("new-word").value = "";
        document.getElementById("definition-preview").classList.remove("show");
        loadWords();
    } catch (err) {
        showStatus("Error adding word: " + err.message, "error");
    }
}

// Load all words and separate them
async function loadWords() {
    try {
        const res = await fetch(`${API}/words/all`);
        const data = await res.json();
        
        const words = data.words || data || [];
        
        const unusedWords = words.filter(w => !w.tested);
        const testedWords = words.filter(w => w.tested);
        
        renderWordList("unused-words", unusedWords, true);
        renderWordList("tested-words", testedWords, false);
    } catch (err) {
        console.error("Error loading words:", err);
        document.getElementById("unused-words").innerHTML = '<p class="error-msg">Error loading words</p>';
        document.getElementById("tested-words").innerHTML = '<p class="error-msg">Error loading words</p>';
    }
}

function renderWordList(containerId, words, showMarkTested) {
    const container = document.getElementById(containerId);
    
    if (words.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic;">No words in this category</p>';
        return;
    }
    
    let html = "<ul>";
    words.forEach((w, index) => {
        const wordEscaped = escapeHtml(w.word);
        const defEscaped = escapeHtml(w.definition);
        html += `
            <li>
                <div class="word-info">
                    <strong>${wordEscaped}</strong>: ${defEscaped}
                </div>
                <div>
                    ${showMarkTested ? `<button class="mark-tested-btn" data-word="${wordEscaped}">Mark Tested</button>` : ''}
                    <button class="delete-word-btn" data-word="${wordEscaped}" style="background: #ff6666;">Delete</button>
                </div>
            </li>`;
    });
    html += "</ul>";
    
    container.innerHTML = html;
    
    // Add event listeners using event delegation for security
    container.querySelectorAll('.mark-tested-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            markAsTested(this.dataset.word);
        });
    });
    
    container.querySelectorAll('.delete-word-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            deleteWord(this.dataset.word);
        });
    });
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#039;');
}

async function markAsTested(word) {
    try {
        await fetch(`${API}/words/mark-tested`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({word})
        });
        loadWords();
    } catch (err) {
        alert("Error marking word as tested: " + err.message);
    }
}

async function deleteWord(word) {
    if (!confirm(`Delete "${word}"?`)) return;
    
    try {
        await fetch(`${API}/words/delete/${encodeURIComponent(word)}`, { method: "DELETE" });
        loadWords();
    } catch (err) {
        alert("Error deleting word: " + err.message);
    }
}

// Initialize
checkAuth();
loadWords();
</script>

</body>
</html>
